<link rel="import" href="../../iron-pages/iron-pages.html"> <link rel="import" href="../../iron-input/iron-input.html"> <link rel="import" href="../../fa-awesome/fa-awesome.html"> <link rel="import" href="coinify-trade-page.html"> <link rel="import" href="coinify-auth.html"> <link rel="import" href="coinify-trade-status.html"> <link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-create-quote.html"> <link rel="import" href="coinify-buy-select-payment-method.html"> <link rel="import" href="coinify-buy-isignthis.html"> <link rel="import" href="coinify-register-card.html"> <link rel="import" href="coinify-confirm-order.html"> <link rel="import" href="coinify-kyc-review-status.html"> <link rel="import" href="coinify-buy-bank-instructions.html"> <link rel="import" href="coinify-info.html"> <link rel="import" href="coinify-util-behaviour.html"> <link rel="import" href="coinify-payment.html"> <link rel="import" href="coinify-buy-safecharge-payment.html"> <link rel="import" href="coinify-buy-authenticate-payment.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-kyc-message.html"> <dom-module id="coinify-buy"> <template> <style include="coinify-shared"></style> <coinify-trade-page title="Buy Bitcoin" general-error="{{generalError}}" panel-wrap="{{panelWrap}}" trade-quote="{{tradeQuote}}" trade="{{trade}}" payment-method="{{paymentMethod}}" conv-rates="{{approxConvRates}}" cards="{{cards}}" is-bank-enabled="{{isBankEnabled}}" is-card-enabled="{{isCardEnabled}}"> <iron-pages attr-for-selected="pageId" selected="{{currentPageId}}"> <div pageid="login"> <coinify-auth access-token="{{accessToken}}"> </coinify-auth> </div> <div pageid="createQuote"> <coinify-create-quote id="coinifyCreateQuote" access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" settings="[[settings]]" trader="[[trader]]" trade-quote="{{tradeQuote}}" on-completed="_tradeQuoteCreated" unfinished-trades="{{unfinishedTrades}}" conv-rates="{{approxConvRates}}" is-card-enabled="{{isCardEnabled}}" is-bank-enabled="{{isBankEnabled}}"> </coinify-create-quote> </div> <div pageid="selectPaymentMethod"> <coinify-buy-select-payment-method id="selectPaymentMethod" trader-info="[[trader]]" cards="[[cards]]" payment-method="{{paymentMethod}}" payment-methods-response="[[paymentMethodsResponse]]" card-tokenization-enabled="[[cardTokenizationEnabled]]" on-continue="handleSelectPaymentMethod" on-cancel="_tradeCancelled" is-card-enabled="[[isCardEnabled]]" is-bank-enabled="[[isBankEnabled]]"> </coinify-buy-select-payment-method> </div> <div pageid="kycMessage"> <coinify-kyc-message on-cancel="_tradeCancelled" on-continue="_handleNeedKYCCardContinue" payment-method="[[paymentMethod]]" trader-info="[[trader]]"></coinify-kyc-message> </div> <div pageid="kycReview"> <coinify-buy-isignthis external-id="{{iSignThisExternalId}}" ist-base-url="{{istBaseUrl}}" on-completed="handleISTKYCProcessCompleted"></coinify-buy-isignthis> </div> <div pageid="kycReviewStatus"> <coinify-kyc-review-status access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" kyc-review="{{kycReview}}" on-completed="_handleKycReviewCompleted"> </coinify-kyc-review-status> </div> <div pageid="createTrade"> <coinify-confirm-order id="confirmOrder" access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" trader-info="[[trader]]" price-quote="{{tradeQuote}}" selected-payment-method="[[paymentMethod]]" on-cancel="_tradeCancelled" on-continue="_tradeCreated" return-url="[[returnUrl]]" selected-payment-params="[[selectedPaymentParams]]"> </coinify-confirm-order> </div> <div pageid="authenticatePayment"> <template is="dom-if" if="{{_isStringEqual(paymentMethodType, &apos;safecharge-advanced&apos;)}}"> <coinify-buy-authenticate-payment trade="[[trade]]" external-id="[[iSignThisExternalId]]" provider="[[trade.transferIn.details.provider]]" ist-base-url="[[istBaseUrl]]" provider-payment-url="[[providerPaymentUrl]]" authenticate-payment-with-details="[[authenticatePaymentWithDetails]]" on-completed="handleISTProcessCompleted" on-cancel="_paymentCancelled"> </coinify-buy-authenticate-payment> </template> <template is="dom-if" if="{{_isStringEqual(paymentMethodType, &apos;safecharge-simple&apos;)}}"> <coinify-buy-safecharge-payment trade="[[trade]]" provider-payment-url="{{providerPaymentUrl}}" authenticate-payment-with-details="[[authenticatePaymentWithDetails]]" on-completed="handleISTProcessCompleted" on-cancel="_paymentCancelled"> </coinify-buy-safecharge-payment> </template> <template is="dom-if" if="{{_isStringEqual(paymentMethodType, &apos;isignthis&apos;)}}"> <coinify-buy-isignthis external-id="{{iSignThisExternalId}}" ist-base-url="{{istBaseUrl}}" on-completed="handleISTProcessCompleted"></coinify-buy-isignthis> </template> </div> <div pageid="bankOrderInstructions"> <coinify-buy-bank-instructions trade="[[trade]]"> </coinify-buy-bank-instructions> <template is="dom-if" if="{{newTradeButtonEnabled}}"> <p> <button on-tap="goToCreateQuote" class="btn btn-default" type="button">New trade</button> </p> </template> </div> <div pageid="paymentOrderStatus"> <coinify-trade-status access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" trade="[[trade]]"> </coinify-trade-status> <template is="dom-if" if="{{newTradeButtonEnabled}}"> <p> <button on-tap="goToCreateQuote" class="btn btn-default" type="button">New trade</button> </p> </template> </div> <div pageid="registerCard"> <coinify-register-card id="coinifyRegisterCard" access-token="{{accessToken}}" coinify-api-base-url="[[coinifyApiBaseUrl]]" on-continue="_handleCardRegistered" on-cancel="_handeCardCancel" on-error="_handleApiError"> </coinify-register-card> </div> </iron-pages> </coinify-trade-page> <iron-ajax id="getTrader" auto="" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me" last-response="{{trader}}" on-response="_handleTraderProfileReceived" on-error="_handleApiError" handle-as="json"></iron-ajax> <iron-ajax id="getCards" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/cards" last-response="{{cards}}" on-error="_handleApiError" handle-as="json"></iron-ajax> <iron-ajax id="createReview" method="post" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me/kyc" handle-as="json" last-response="{{kycReview}}" on-error="_handleApiError" on-response="_handleCreateReviewResponse"></iron-ajax> <iron-ajax id="getTrade" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/{{trade.id}}" last-response="{{trade}}" on-response="_onGetTradeResponse" on-error="_handleApiError" handle-as="json"></iron-ajax> <iron-ajax id="getPaymentMethods" auto="" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/payment-methods" last-response="{{paymentMethodsResponse}}" on-error="_handleApiError" handle-as="json"></iron-ajax> <iron-ajax id="getTrades" auto="" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades" last-response="{{tradesApiResponse}}" on-response="_onTradesResponse" on-error="_onTradesError" handleas="json"></iron-ajax> <iron-ajax id="approxConvRateEndpoint" url="{{coinifyApiBaseUrl}}/rates/approximate" content-type="application/json" handle-as="json"></iron-ajax> </template> <script>Polymer({is:"coinify-buy",behaviors:[Polymer.AppLocalizeBehavior,CoinifyApiBehaviour,CoinifyUtilsBehavior],listeners:{"general-error":"_handleErrorEvent","price-quote-expired":"_refreshPriceQuote","coinify-payment-completed":"handleISTProcessCompleted"},properties:{language:{value:"en"},generalError:String,panelWrap:{type:Object,value:!0},componentWidth:Number,componentHeight:Number,settings:{type:Object,value:{direction:"buy",minAmount:50,minCurrency:"EUR",inCurrencies:["EUR","USD","GBP","DKK"],outCurrencies:["BTC"]}},currentPageId:{type:String,value:"createQuote",notify:!0,observer:"_currentPageIdChanged"},trader:Object,cards:Object,tradeQuote:Object,trade:{type:Object,observer:"_tradeUpdated"},tradesApiResponse:{type:Object},paymentMethod:String,paymentMethodType:String,kycReview:Object,approxConvRates:{type:Object,value:{USD:.85,EUR:1,GBP:1.14,DKK:.13},notify:!0},istBaseUrl:{type:String,value:"https://verify.isignthis.com"},onCancelCallback:Object,_onTradesResponseCallback:Object,iSignThisExternalId:String,providerPaymentUrl:String,newTradeButtonEnabled:{type:Boolean,value:!1},fetchedRates:{type:Boolean,value:!1},fetchingRates:{type:Boolean,value:!1},unfinishedTrades:{type:Boolean,value:!1,notify:!0},selectedPaymentParams:{type:Object,observer:"_selectedPaymentParamsUpdated",notify:!0},authenticatePaymentWithDetails:{type:Object,notify:!0},cardTokenizationEnabled:{type:Boolean,notify:!0},isCardEnabled:{type:Boolean,value:!0,notify:!0},isBankEnabled:{type:Boolean,value:!0,notify:!0}},attached:function(){if(window.CoinifyPspLib){var e=this.coinifyApiBaseUrl,t=e.indexOf("sandbox")>=0||e.indexOf("localhost")>=0||e.indexOf("ngrok")>=0;window.CoinifyPspLib.setOptions({verbose:t,coinifyApiBaseUrl:e})}else console.error("Failed to load PSP library");return this.accessToken?this.trade?(this.paymentMethod=this.trade.transferIn.medium,void this._initProcessTrade()):void this._initBuyOrderProcess():void this.set("currentPageId","login")},ready:function(){this.loadResources("assets/config/locales.json"),this.addEventListener("userAuthorized",this.userAuthorized)},_isProviderSafeChargeAndPayingWithSavedCard:function(e,t,n){var r=!(!t||!t.card);return"safecharge"===e&&r==n},_tradeUpdated:function(e){var t=this,n=["awaiting_transfer_in","processing"];this.trade&&this.trade.id&&(!e||n.includes(this.trade.state))&&setTimeout(function(){t.$.getTrade.generateRequest()},5e3)},_onGetTradeResponse:function(){},calculateUnfinishedTrades:function(){this.tradesApiResponse&&this.tradesApiResponse.length>0&&this.trader?this.unfinishedTrades=1===this.tradesApiResponse.length&&this.tradesApiResponse.filter(function(e){return["awaiting_transfer_in"].includes(e.state)}).length>0&&1===this.trader.level.id:this.unfinishedTrades=!1},_tradeQuoteCreated:function(){return this.trader?(this.calculateUnfinishedTrades(),void(this.unfinishedTrades?console.log("Cannot continue - unfinished trades present."):this.set("currentPageId","selectPaymentMethod"))):void console.error("Trader object not initialized - cannot set payment method")},getCardTokenizationEnabled:function(){var e=(this.trader.email||"").toLowerCase();return e.indexOf("+test-tokenize@coinify.com")>=0||e.indexOf("test+trader1@coinify.com")>=0||0==e.indexOf("staff@coinify.com")},handleSelectPaymentMethod:function(e){if(e&&e.detail&&"card"===e.detail.method&&this.cardTokenizationEnabled)if(e.detail.card){var t=Object.assign({},e.detail.card);if(this.selectedPaymentParams?(this.selectedPaymentParams.card=t,this.selectedPaymentParams=Object.assign({},this.selectedPaymentParams)):this.selectedPaymentParams={card:t},!t.CVV)return void console.error("No CVV");this._initCreateTrade()}else this._showRegisterCard();else this.selectedPaymentParams=null,this._initCreateTrade()},handleISTProcessCompleted:function(){this.currentPageId="paymentOrderStatus"},_handleNeedKYCCardContinue:function(){this.$.createReview.generateRequest()},handleISTKYCProcessCompleted:function(){this.currentPageId="kycReviewStatus"},_handleKycReviewCompleted:function(e){this.$.getTrader.generateRequest(),this.currentPageId="createTrade"},_paymentCancelled:function(){this._tradeCancelled(),this.onCancelCallback&&this.onCancelCallback()},_tradeCancelled:function(){this.resetTrade(),this.$.coinifyCreateQuote.resetElement(),this._initBuyOrderProcess()},_tradeCreated:function(e){var t=this;console.log("Trade created ",e.detail.trade),this.trade=e.detail.trade;var n=this.trade.transferIn.details;if(!n)return void console.error("Failed to select payment method. Trade did not contain transferIn details.");var r=n.provider;r||(console.warn("The transferIn details did not contain a provider, falling back on safecharge."),r="safecharge");var i=[];this._isProviderSafeChargeAndPayingWithSavedCard(r,this.selectedPaymentParams,!1)?(this.paymentMethodType="safecharge-simple",n.cardPaymentId&&n.redirectUrl&&n.returnUrl||console.warn("Missing one or more transferIn details"),i=["cardPaymentId","provider","redirectUrl","returnUrl"]):this._isProviderSafeChargeAndPayingWithSavedCard(r,this.selectedPaymentParams,!0)?(this.paymentMethodType="safecharge-advanced",i=["acsUrl","paRequest"]):this._isStringEqual(r,"isignthis")&&(this.paymentMethodType="isignthis",i=["cardPaymentId","paymentId","provider","redirectUrl"],n&&n.paymentId&&n.paymentId.length!=="8bdfe389-16f3-4fb6-baf1-70c7d8c3c0fc".length&&console.warn("Invalid paymentId format; "+n.paymentId)),i.forEach(function(e){void 0!==n[e]&&null!==n[e]||console.error("Missing transferIn details argument; "+e+"; provider="+r+"; paymentMethodType="+t.paymentMethodType)}),this._initProcessTrade()},_computeEURRateParams:function(){return{baseCurrency:this.tradeQuote.baseCurrency,quoteCurrency:"EUR"}},_handleCardRegistered:function(e){if(this.paymentMethod="card",!e||!e.detail)return void console.error("no event argument value");var t=!!e.detail.ccTempToken,n=void 0;return n=t?{ccTempToken:e.detail.ccTempToken,CVV:e.detail.CVV,sessionToken:e.detail.sessionToken}:{cardExternalId:e.detail.cardExternalId,CVV:e.detail.CVV},n.CVV?n.ccTempToken&&!n.sessionToken?void console.error("No sessionToken for paying with ccTempToken"):n.ccTempToken&&n.cardExternalId?void console.error("No ccTempToken or cardExternalId for paying with ccTempToken"):(this.selectedPaymentParams={provider:e.detail.provider||"safecharge",card:n},void this._initCreateTrade()):void console.error("No CVV when initiating card payment.")},_handeCardCancel:function(e){this.currentPageId="createQuote"},_handleErrorEvent:function(e){this.generalError=e.detail.message},resetTrade:function(){this.$.coinifyCreateQuote.resetElement(),this.tradeQuote=null,this.$.selectPaymentMethod.resetElement(),this.$.confirmOrder._resetElement(),this.trade=null},userAuthorized:function(){this._initBuyOrderProcess()},_initBuyOrderProcess:function(){this.fetchRates(),this.currentPageId="createQuote"},_onTradesResponse:function(){if(this._onTradesResponseCallback){var e=this._onTradesResponseCallback;this._onTradesResponseCallback=null,e()}},_onTradesError:function(e){console.log("Error fetching trades from API: ",e),this.generalError="We encountered an error while getting trades - please try again later."},_showRegisterCard:function(){this.$.coinifyRegisterCard._resetForm(),this.currentPageId="registerCard"},_initCreateTrade:function(){var e=this;if(!this.trader)return void console.error("Trader object not initialized");if(this.trader.nextLevel&&this.trader.nextLevel.requirements){var t=this.trader.nextLevel.requirements.find(function(e){return"kyc"==e.type});if(t&&t.fulfilled===!1){var n=this.paymentMethodsResponse.find(function(t){return t.inMedium==e.paymentMethod});if(!n)return void console.error("Payment method not found");if(!n.limitInAmounts)return void console.error("Limit in amount not in payment method");if("bank"===n.inMedium)return void(this.currentPageId="kycMessage");if("card"===n.inMedium)return this._onTradesResponseCallback=function(){var t=e._purchasePriceInBoundsOfMinAndMaxDailyLimit(n),r=e._purchasePriceExceedsKycForCardLimitInAmounts(n,t),i=r.purchaseWillExceedYearlyLimit;return i&&t?void(e.currentPageId="kycMessage"):void(e.currentPageId="createTrade")},void this.$.getTrades.generateRequest()}}this.currentPageId="createTrade"},_getBounds:function(e){this.trader||console.error("Trader object not initialized yet");var t=this.getConvRates(),n=Math.abs(this.tradeQuote.baseAmount),r=this.tradeQuote.baseCurrency,i=n*(t[r]||1),a=e.minimumInAmounts[r],s=a*(t[r]||1),o=this.trader.level.limits[this.paymentMethod]["in"].daily,d=o/(t[r]||1);return void 0!==o&&null!==o||console.error("No current limits available"),{min:a,max:d,minAmtInAccountCur:s,maxAmtInAccountCur:o,amountInAccountCur:i,base:n,lessThanAllowed:n<a,moreThanAllowed:i>o}},_purchasePriceInBoundsOfMinAndMaxDailyLimit:function(e){var t=this._getBounds(e);return t.minAmtInAccountCur>0&&t.amountInAccountCur>=t.minAmtInAccountCur&&t.amountInAccountCur<=t.maxAmtInAccountCur},_purchasePriceExceedsKycForCardLimitInAmounts:function(e,t){var n={daily:!1,yearly:!1},r=this.getConvRates(),i={daily:0,yearly:0};this.tradesApiResponse.forEach(function(t,n){var a=Math.floor(new Date(t.updateTime).getTime()/1e3);if(isNaN(a))return void console.error("Update time is not a valid date");var s=Math.floor(Date.now()/1e3),o=86400,d=31536e3,c=s-a<=o,l=s-a<=d,u=0,h=0;"completed"===t.state&&t.transferIn.medium==e.inMedium&&t.transferOut.medium==e.outMedium&&(c&&(i.daily+=t.inAmount*(r[t.inCurrency]||1),u++),l&&(i.yearly+=t.inAmount*(r[t.inCurrency]||1),h++))});var a=this.trader.level.limits[e.inMedium],s=Math.abs(this.tradeQuote.baseAmount),o=s*(r[this.tradeQuote.baseCurrency]||1);if(a){var d=a&&a["in"]?a["in"].daily:0,c=a&&a["in"]?a["in"].yearly:0;n.daily=i.daily+o>d,n.yearly=i.yearly+o>c}else console.error("Limits not defined for method");var l=this.tradeQuote.baseCurrency,u=e.limitInAmounts[l],h=s>u;return console.log("[KYC Card Evaluation] canTrade="+e.canTrade+"; amount spend=",i,"; unspecifed limit in for payment input currency=",u,"; unspecified limits exceeded=",h,"; limits exceeded=",n,"; limit definitions for "+e.inMedium+" = ",a["in"],"; amount is inside allowed bounds = ",t,"; bounds info; ",this._getBounds(e)),{purchaseWillExceedYearlyLimit:n.yearly,purchaseWillExceedDailyLimit:n.daily}},_initProcessTrade:function(){switch(this.paymentMethod){case"card":var e=this.trade.transferIn.details;this.authenticatePaymentWithDetails=e,e&&this.selectedPaymentParams&&this.selectedPaymentParams.card&&this.selectedPaymentParams.card.CVV&&(this.authenticatePaymentWithDetails.CVV=this.selectedPaymentParams.card.CVV),this.providerPaymentUrl=e.redirectUrl,this.iSignThisExternalId=e.paymentId,this.currentPageId="authenticatePayment";break;case"bank":this.currentPageId="bankOrderInstructions";break;default:this.generalError="Payment method is not selected"}},fetchRates:function(){var e=this;if(!this.trader)return void setTimeout(this.fetchRates,500);if(!this.fetchedRates){this.fetchingRates=!0;var t=Object.assign({},this.getConvRates()),n=this,r=0,i=function(i){if(n.fetchingRates&&!n.fetchedRates)return++r>=4?(e.approxConvRates=t,n.fetchedRates=!0,void(n.fetchingRates=!1)):void 0},a=function(e){var n=e.response;t[n.baseCurrency]=n.rate,i()},s=function(e){this.errorMessage="Could not connect to API"},o=this.trader.defaultCurrency,d=["USD","DKK","GBP","EUR"];d.forEach(function(t){e.$.approxConvRateEndpoint.set("params",{baseCurrency:t,quoteCurrency:o});var n=e.$.approxConvRateEndpoint.generateRequest();n.completes.then(a,s)})}},getConvRates:function(){return this.approxConvRates},_handleTraderProfileReceived:function(){this.cardTokenizationEnabled=this.getCardTokenizationEnabled(),console.log("*** card tokenization "+(this.cardTokenizationEnabled?"enabled":"disabled")+" ***"),this.cardTokenizationEnabled&&this.$.getCards.generateRequest(),this.fetchingRates||this.fetchedRates||this.fetchRates()},_handleCreateReviewResponse:function(){this.iSignThisExternalId=this.kycReview.externalId,this.currentPageId="kycReview"},computePaymentFee:function(e,t,n){return t+e*n/100},_formatAsEur:function(e){return parseFloat(e).toFixed(2)+" EUR"},_formatAsDate:function(e){var t=new Date(e),n={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",timeZoneName:"short"};return t.toLocaleDateString("en-GB",n)},authenticatePayment:function(){this.set("currentPageId","paymentOrderStatus")},goToCreateQuote:function(){this.resetTrade(),this.set("currentPageId","createQuote")},_currentPageIdChanged:function(){this.set("generalError","")},_selectedPaymentParamsUpdated:function(){},_istFlowCompleted:function(e){return!(!e||!e.state)&&"awaiting_transfer_in"!==e.state},_refreshPriceQuote:function(){this.$.coinifyCreateQuote._createQuote()}})</script> </dom-module>
<link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-alert-message.html"> <link rel="import" href="../../iron-input/iron-input.html"> <link rel="import" href="../../iron-icons/iron-icons.html"> <dom-module id="coinify-confirm-order"> <template> <style include="coinify-shared"></style> <style>.text-danger{padding-top:5px}.checkbox{padding-top:10px}#agree-tos{margin-top:2px}.agree-tos-label{margin-left:-20px}.cancellation-rights{font-weight:700}</style> <h4>Confirm your order:</h4> <coinify-alert-message alert-message="{{errorMessage}}"></coinify-alert-message> <p> Please confirm your order details before you continue. </p> <div hidden$="[[!_isStringEqual(selectedPaymentMethod, &apos;card&apos;)]]" class="alert alert-warning"> <p> Your card will be charged and may enter a security review which may take one business day. If rejected, a refund will be issued which may take a few days to show in your bank account. </p> </div> <template is="dom-if" if="{{showPriceChangeWarning}}" restamp="true"> <div class="alert alert-info"> <p>Please note that the quoted price displayed in this offer is an indicative price. The price will change according to the given exchange rate at the time Coinify ApS processes your order.</p> </div> </template> <div class="row"> <div class="col-xs-8"> <template is="dom-if" if="{{maxLimitExceeded}}"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Exceeds your remaining daily {{direction}} amount of [[_formatAmount(maxLimit, priceQuote.baseCurrency)]]</span> </div> </template> <template is="dom-if" if="{{minLimitExceeded}}"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Below your minimum {{direction}} amount of [[_formatAmount(minLimit, priceQuote.baseCurrency)]]</span> </div> </template> </div> <div class="col-xs-4"> <button on-tap="_toggleEditOrder" class="btn btn-link pull-right">[[editOrderText]]</button> </div> </div> <label>You Pay:</label> <ul class="list-group"> <li class="list-group-item"> <div class="row"> <div class="col-xs-3"> <label>{{priceQuote.baseCurrency}}:</label> </div> <template is="dom-if" if="{{editMode}}"> <div class="col-xs-4 text-right"> <button on-tap="_updatePriceQuote" class="btn btn-link" disabled="{{limitsExceeded}}"> Update </button> </div> <div class="col-xs-5"> <div class="input-group pull-right"> <input is="iron-input" bind-value="{{baseAmountAbs}}" type="number" class="form-control"> <span class="input-group-btn" style="width:0"></span> <select class="select-currency form-control input-group-addon" value="{{priceQuote.baseCurrency::change}}"> <template is="dom-repeat" items="{{paymentMethodObject.inCurrencies}}" as="currency"> <option>{{currency}}</option> </template> </select> </div> </div> </template> <template is="dom-if" if="{{!editMode}}"> <div class="col-xs-9"> <span class="pull-right">[[_formatAmount(baseAmountAbs, priceQuote.baseCurrency)]]</span> </div> </template> </div> </li> <template is="dom-if" if="[[!_amountIsZero(transferInFee)]]"> <li class="list-group-item no-top-border"> <label>Payment Fee:</label> <span class="pull-right">[[_formatAmount(transferInFee, priceQuote.baseCurrency)]]</span> </li> <li class="list-group-item"> <label>Total Payment Cost</label> <span class="pull-right">[[_formatAmount(transferInTotal, priceQuote.baseCurrency)]]</span> </li> </template> </ul> <label>You Receive:</label> <ul class="list-group"> <li class="list-group-item"> <label>{{priceQuote.quoteCurrency}} Order:</label> <span class="pull-right">[[_formatAmount(priceQuote.quoteAmount, priceQuote.quoteCurrency)]]</span> </li> <template is="dom-if" if="[[!_amountIsZero(transferOutFee)]]"> <li class="list-group-item"> <label>{{quoteCurrency}} Transaction Fee:</label> <span class="pull-right">[[_formatAmount(transferOutFee, priceQuote.quoteCurrency)]]</span> </li> <li class="list-group-item"> <label>{{priceQuote.quoteCurrency}} Total:</label> <span class="text-success pull-right">[[_formatAmount(transferOutTotal, priceQuote.quoteCurrency)]]</span> </li> </template> </ul> <form on-submit="_createTrade"> <template is="dom-if" if="{{!hideBitcoinAddressUserInput}}"> <div class="alert alert-warning"> <p>Coinify will deliver Bitcoin for this order to the Bitcoin wallet address you enter below. As transactions on the Blockchain network are irreversible, please check for typos and make sure you use a Bitcoin wallet address you own and have access to.</p> </div> <div class="form-group"> <label>Bitcoin wallet address for delivery:</label> <input class="form-control" is="iron-input" bind-value="{{bitcoinAddress}}" placeholder="Address to transfer bitcoin to" required> <a class="pull-right" target="_blank" href="https://help.coinify.com/article/158-creating-a-web-wallet-on-blockchain"> Don&apos;t have a Bitcoin wallet? </a> </div> </template> <div class="checkbox"> <label> <input id="agree-tos" type="checkbox" checked="{{termsAccepted::change}}"> <label for="agree-tos"><span class="agree-tos-label">I am aware of the risks involved with digital currencies and accept </span><a href="https://www.coinify.com/legal" target="_blank">Coinify terms and conditions</a>.</label> </label> </div> <p class="cancellation-rights">When you complete the purchase, you accept that your cancellation rights does not apply in relation to the purchase.</p> <button on-tap="_cancelTrade" class="btn btn-default" type="button">Cancel</button> <button class="btn btn-success pull-right" type="submit" disabled="{{continueBtnDisabled}}">Continue</button> </form> <iron-ajax id="traderInfoEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me" last-response="{{traderInfo}}" on-error="_handleApiError" handleas="json"> </iron-ajax> <iron-ajax id="createTrade" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades" on-response="_handleApiTradeResponse" last-response="{{createTradeResponse}}" on-error="_errorCreatingTrade" body="{{createTradeRequest}}" method="POST" content-type="application/json" handle-as="json"> </iron-ajax> <iron-ajax id="createPriceQuote" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/quote" last-response="{{priceQuote}}" on-error="_handleApiError" body="{{priceQuote}}" method="POST" content-type="application/json" handle-as="json"> </iron-ajax> <iron-ajax id="getRates" auto="" url="{{coinifyApiBaseUrl}}/rates/approximate" params="{{approxRateParams}}" last-response="{{approxRateResponse}}" on-error="_handleApiError" handle-as="json"> </iron-ajax> <iron-ajax id="getPaymentMethods" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/payment-methods" params="{{paymentMethodParams}}" last-response="{{paymentMethodsResponse}}" on-response="_handlePaymentMethodsResponse" on-error="_handleApiError" handle-as="json"></iron-ajax> </template> <script>Polymer({is:"coinify-confirm-order",behaviors:[CoinifyUtilsBehavior,CoinifyApiBehaviour],properties:{traderInfo:{type:Object,value:{defaultCurrency:"DKK"}},priceQuote:{type:Object,value:{baseCurrency:"EUR"},notify:!0,observer:"_propertyUpdated"},selectedBankAccount:Object,showPriceChangeWarning:{type:Boolean,value:!0},selectedPaymentMethod:{type:String,notify:!0,observer:"_propertyUpdated"},selectedPaymentParams:{type:Object,notify:!0,observer:"_propertyPaymentParamsUpdated"},direction:{type:String,value:"buy"},approxRateResponse:Object,paymentMethodObject:Object,paymentMethodsResponse:Object,termsAccepted:{type:Boolean,value:!1},hideBitcoinAddressUserInput:{type:Boolean,value:!1},bitcoinAddress:String,baseAmount:{type:Number},editMode:{type:Boolean,value:!1},editOrderText:{type:String,value:"Edit Order"},currencies:{type:Array,value:["EUR","USD","GBP","DKK"]},createTradeResponse:Object,createTradeRequest:Object,baseAmountAbs:{type:Number},approxRateParams:{type:Object,computed:"_computeRateParams(traderInfo.defaultCurrency, priceQuote.baseCurrency)"},paymentMethodParams:{type:Object,computed:"_computePaymentMethodParams(priceQuote.baseCurrency, priceQuote.quoteCurrency)"},maxLimit:{type:Number,computed:"_computeMaxLimit(traderInfo.currentLimits, approxRateResponse, selectedPaymentMethod)"},maxLimitExceeded:{type:Boolean,computed:"_computeMaxLimitExceeded(baseAmountAbs, maxLimit)"},minLimit:{type:Number,computed:"_computeMinLimit(approxEurRateResponse)"},minLimitExceeded:{type:Boolean,value:!1},continueBtnDisabled:{type:Boolean,computed:"_computeContinueBtnDisabled(limitsExceeded, editMode, termsAccepted)"},limitsExceeded:{type:Boolean,computed:"_computeLimitsExceeded(minLimitExceeded, maxLimitExceeded)"},transferInFee:{type:Number,computed:"_computeTransferFee(priceQuote.baseAmount, priceQuote.baseCurrency, paymentMethodObject.inFixedFees, paymentMethodObject.inPercentageFee)"},transferOutFee:{type:Number,computed:"_computeTransferFee(priceQuote.quoteAmount, priceQuote.quoteCurrency, paymentMethodObject.outFixedFees, paymentMethodObject.outPercentageFee)"},transferInTotal:{type:Number,computed:"_computeTransferInTotal(priceQuote.baseAmount, transferInFee)"},transferOutTotal:{type:Number,computed:"_computeTransferOutTotal(priceQuote.quoteAmount, transferOutFee)"},returnUrl:{type:String,notify:!0,observer:"_propertyReturnUrlUpdated"},errorMessage:{type:String},creatingTrade:{type:Boolean,value:!1}},attached:function(){this.$.traderInfoEndpoint.generateRequest()},_resetElement:function(){this.set("termsAccepted",!1),this.set("bitcoinAddress","")},_toggleEditOrder:function(){this.editMode&&(this.baseAmountAbs=Math.abs(this.priceQuote.baseAmount)),this.editMode=!this.editMode,this.editOrderText=this.editMode?"Cancel":"Edit Order"},_updatePriceQuote:function(){this.priceQuote.baseAmount=-this.baseAmountAbs,this.$.createPriceQuote.generateRequest(),this.$.getPaymentMethods.generateRequest(),this.editMode=!1,this.editOrderText="Edit Order"},_createTrade:function(e){return e.preventDefault(),this.creatingTrade?void console.error("Avoid double clicking"):(this.createTradeRequest={priceQuoteId:this.priceQuote.id,transferIn:{medium:this.paymentMethodObject.inMedium,details:{returnUrl:this.returnUrl}},transferOut:{medium:this.paymentMethodObject.outMedium,details:{account:this.bitcoinAddress}}},"sell"===this.direction&&"bank"===this.selectedPaymentMethod&&(this.createTradeRequest.transferOut.mediumReceiveAccountId=this.selectedBankAccount.id),"buy"===this.direction&&"card"===this.selectedPaymentMethod&&this.selectedPaymentParams&&this.selectedPaymentParams.card&&(this.createTradeRequest.transferIn.details.card=this.selectedPaymentParams.card),this.creatingTrade=!0,void this.$.createTrade.generateRequest())},_errorCreatingTrade:function(e){this.creatingTrade=!1,this._handleApiError(e)},_cancelTrade:function(){return this.creatingTrade?void console.error("Cannot cancel while creating a trade"):void this.fire("cancel",null,{bubbles:!1})},_handleApiTradeResponse:function(e,t){this.creatingTrade=!1,this.fire("continue",{trade:this.createTradeResponse},{bubbles:!1})},_handlePaymentMethodsResponse:function(){var e=this.selectedPaymentMethod,t=this.paymentMethodsResponse;return"sell"===this.direction?(this.paymentMethodObject=t.find(function(t){return t.outMedium===e}),void(this.showPriceChangeWarning=!1)):(this.paymentMethodObject=t.find(function(t){return t.inMedium===e}),void(this.showPriceChangeWarning="bank"===e))},_propertyUpdated:function(){var e=this.priceQuote;e||(this.priceQuote={baseCurrency:"EUR"}),this.selectedPaymentMethod&&e&&(this.baseAmountAbs=Math.abs(e.baseAmount),this.$.getPaymentMethods.generateRequest())},_propertyPaymentParamsUpdated:function(){},_propertyReturnUrlUpdated:function(){},_formatAmount:function(e,t){return"BTC"===t?parseFloat(e).toFixed(8)+" "+t:parseFloat(e).toFixed(2)+" "+t},_computeTransferFee:function(e,t,r,n){var a=Math.abs(e);return r[t]+a*n/100},_computeTransferInTotal:function(e,t){var r=Math.abs(e);return r+parseFloat(t)},_computeTransferOutTotal:function(e,t){var r=Math.abs(e);return r-parseFloat(t)},_computeRateParams:function(e,t){return{baseCurrency:e,quoteCurrency:t}},_computePaymentMethodParams:function(e,t){return{inCurrency:e,outCurrency:t}},_computeMaxLimit:function(e,t,r){if(!e||!t||!r)return null;var n="buy"===this.direction?e[r]["in"]:e[r].out;return n*t.rate},_computeMinLimit:function(e){var t=10;return t*e.rate},_computeMaxLimitExceeded:function(e,t){return e>t},_computeMinLimitExceeded:function(e,t){return e<t},_computeContinueBtnDisabled:function(e,t,r){return e||t||!r},_computeLimitsExceeded:function(e,t){return e||t},_amountIsZero:function(e){return 0===e},_handleApiError:function(e){try{var t=e.detail.request.xhr.response.error,r=e.detail.request.xhr.response.error_description;switch(t){case"invalid_blockchain_account":this.errorMessage="The provided Bitcoin address is not valid";break;case"wait_after_first_trade":this._updateWaitAfterFirstTradeErrorMessage();break;default:this.errorMessage=r}}catch(n){this.errorMessage="Unknown error"}},_updateWaitAfterFirstTradeErrorMessage:function(){var e=this,t="Sorry, after completing your first trade, you need to wait 7 days before you can create another trade. Please try again after the 7 days have passed. This is a one time security check. Thank you for your patience!";this.$.traderInfoEndpoint.generateRequest().completes.then(function(){if(!e.traderInfo||!e.traderInfo.canTradeAfter)return void(e.errorMessage=t);var r=new Date(e.traderInfo.canTradeAfter).toLocaleString();e.errorMessage="Sorry, after completing your first trade, you need to wait 7 days before you can create another trade. Your account will be open for trade again on "+r+". This is a one time security check. Thank you for your patience!"},function(r){e.errorMessage=t})}})</script> </dom-module>
<link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-currency-input.html"> <link rel="import" href="coinify-util-behaviour.html"> <dom-module id="coinify-create-quote"> <template> <style include="coinify-shared"></style> <style>.icon{float:left;padding-top:5px}</style> <coinify-alert-message id="errorBox" alert-message="[[errorMessage]]"></coinify-alert-message> <iron-ajax id="approxRateEndpoint" url="{{coinifyApiBaseUrl}}/trades/quote" headers="{{ajaxHeaders}}" body="{{approxRateParams}}" on-response="_handleApproxRateResponse" on-error="_handleApiError" last-response="{{approxRateResponse}}" method="POST" content-type="application/json" handle-as="json"> </iron-ajax> <iron-ajax id="tradeQuoteEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/quote" body="{{createQuoteBody}}" on-response="_handleTradeQuoteResponse" on-error="_handleApiError" last-response="{{tradeQuote}}" method="POST" content-type="application/json" handle-as="json"> </iron-ajax> <iron-ajax id="getRatesFromSettings" url="{{coinifyApiBaseUrl}}/rates/approximate" params="{{ratesFromSettingsParams}}" last-response="{{ratesFromSettingsResponse}}" handle-as="json"> </iron-ajax> <iron-ajax id="getRatesFromDefaultCurrency" url="{{coinifyApiBaseUrl}}/rates/approximate" params="{{getRatesFromDefaultCurrencyParams}}" last-response="{{ratesFromDefaultCurrencyResponse}}" handle-as="json"> </iron-ajax> <iron-ajax id="getPaymentMethods" auto="" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades/payment-methods" last-response="{{paymentMethodsResponse}}" on-error="_handleApiError" handle-as="json"> </iron-ajax> <template is="dom-if" if="{{isDirectionBuy}}"> <h4>Select amount you want to buy Bitcoins for</h4> </template> <template is="dom-if" if="{{isDirectionSell}}"> <h4>Select amount of Bitcoins you want to sell</h4> </template> <form on-submit="_submitAmount"> <label>Enter amount:</label> <template is="dom-if" if="{{isDirectionBuy}}"> <coinify-info width="200"> Current minimum amounts are [[_formatAmountAlt(minAmountBuyCard, inCurrencySelected)]] for credit card and [[_formatAmountAlt(minAmountBuyBank, inCurrencySelected)]] for bank transfers. Maximum amounts are [[_formatAmountAlt(maxInAmountCard, inCurrencySelected)]] for credit card and [[_minDisplayAmountForBank(maxInAmountBank, inCurrencySelected)]] for bank transfers. </coinify-info> </template> <template is="dom-if" if="{{isDirectionSell}}"> <coinify-info width="200"> Minimum sell amount is [[_formatAmountAlt(minAmountSell, inCurrencySelected)]]. Current maximum amount is [[_formatAmountAlt(maxOutAmountBank, inCurrencySelected)]] for bank transfers. </coinify-info> </template> <div class="row"> <div class="col-xs-5"> <coinify-currency-input id="currencyInput" currencies="{{settings.inCurrencies}}" currency-selected="{{inCurrencySelected}}" amount="{{inAmount}}"> </coinify-currency-input> </div> <div class="icon"> <fa-awesome icon="fa:exchange" size="24"></fa-awesome> </div> <div class="col-xs-5"> <coinify-currency-input currencies="{{settings.outCurrencies}}" currency-selected="{{outCurrencySelected}}" amount="{{approxQuote}}" disable-input="false"> </coinify-currency-input> </div> </div> <button type="submit" disabled="{{!continueButtonEnabled}}" class="btn btn-success pull-right">Continue</button> </form> <div class="row"> <div class="col-xs-9"> <template is="dom-if" if="{{unfinishedTrades}}"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>We have noticed you have a pending order which needs to be finalized before placing a new one. You can manage pending orders from your trade history in the menu.</span> </div> </template> <template is="dom-if" if="{{!unfinishedTrades}}"> <template is="dom-if" if="{{minLimitExceeded}}"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Below your minimum amount limit of [[_formatAmount(minLimit, inCurrencySelected)]]</span> </div> </template> <template is="dom-if" if="{{maxLimitExceeded}}"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Exceeds your maximum amount limit of [[_formatAmount(maxLimit, inCurrencySelected)]]</span> </div> </template> <template is="dom-if" if="{{belowMinBankAmountCardIsOkay}}"> <div class="text-success"> <iron-icon icon="icons:check"></iron-icon> <span>Your available amount is [[_formatAmount(maxLimitCard, inCurrencySelected)]] for credit/debit card payments</span><template is="dom-if" if="{{_isGreaterThan(maxLimitBank,0)}}"> and [[_formatAmount(maxLimitBank, inCurrencySelected)]] for bank transfer payments</template> </div> <template is="dom-if" if="[[_isGreaterThan(minLimitBank, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Below your minimum amount limit of [[_formatAmount(minLimitBank, inCurrencySelected)]] for bank transfer payments</span> </div> </template> <template is="dom-if" if="[[_isLessThanOrEqualTo(minLimitBank, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>You have spend all of your available daily amount limit for bank transfer payments</span> </div> </template> </template> <template is="dom-if" if="{{maxCardLimitExceededBankIsOkay}}"> <div class="text-success"> <iron-icon icon="icons:check"></iron-icon> <span>Your available amount is [[_formatAmount(maxLimitBank, inCurrencySelected)]] for bank transfer payments</span><template is="dom-if" if="{{_isGreaterThan(maxLimitCard,49)}}"> and [[_formatAmount(maxLimitCard, inCurrencySelected)]] for credit/debit card payments</template> </div> <template is="dom-if" if="[[_isGreaterThan(maxLimitCard, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Exceeds your maximum amount limit of [[_formatAmount(maxLimitCard, inCurrencySelected)]] for credit/debit payments</span> </div> </template> <template is="dom-if" if="[[_isLessThanOrEqualTo(maxLimitCard, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>You have spend all of your available daily amount limit for credit/debit card payments</span> </div> </template> </template> <template is="dom-if" if="{{betweenMaxCardAndMinBank}}"> <div class="text-success"> <iron-icon icon="icons:check"></iron-icon> <span>Your available amount is [[_formatAmount(maxLimitBank, inCurrencySelected)]] for bank transfer payments</span><template is="dom-if" if="{{_isGreaterThan(maxLimitCard,49)}}"> and [[_formatAmount(maxLimitCard, inCurrencySelected)]] for credit/debit card payments</template> </div> <template is="dom-if" if="[[_isGreaterThan(maxLimitCard, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Exceeds your maximum amount limit of [[_formatAmount(maxLimitCard, inCurrencySelected)]] for credit/debit payments</span> </div> </template> <template is="dom-if" if="[[_isGreaterThan(maxLimitBank, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>Below your minimum amount limit of [[_formatAmount(minLimitBank, inCurrencySelected)]] for bank transfer payments</span> </div> </template> <template is="dom-if" if="[[_isLessThanOrEqualTo(maxLimitCard, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>You have spend all of your available daily amount limit for credit/debit card payments</span> </div> </template> <template is="dom-if" if="[[_isLessThanOrEqualTo(maxLimitBank, 0)]]"> <div class="text-danger"> <iron-icon icon="icons:warning"></iron-icon> <span>You have spend all of your available daily amount limit for bank transfer payments</span> </div> </template> </template> </template> </div> <div class="col-xs-4"> <button on-tap="_toggleEditOrder" class="btn btn-link pull-right">[[editOrderText]]</button> </div> </div> </template> <script>var get=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},set=function t(e,n,i,r){var a=Object.getOwnPropertyDescriptor(e,n);if(void 0===a){var o=Object.getPrototypeOf(e);null!==o&&t(o,n,i,r)}else if("value"in a&&a.writable)a.value=i;else{var u=a.set;void 0!==u&&u.call(r,i)}return i},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};Polymer({is:"coinify-create-quote",behaviors:[CoinifyUtilsBehavior,CoinifyApiBehaviour],properties:{errorMessage:String,settings:{type:Object,observer:"_onSettingsTraderOrPaymentMethodsChanged"},trader:{type:Object,observer:"_traderChanged"},tradeQuote:{type:Object,notify:!0},tempQuote:{type:Object},inAmount:{type:Number,observer:"_inAmountUpdated"},inAmountDirty:{type:Boolean,value:!1},continueButtonEnabled:{type:Boolean,computed:"_calculateContinueButtonEnabled(inAmount, betweenMaxCardAndMinBank, minLimitExceeded, maxLimitExceeded, unfinishedTrades)"},approxRateResponseTime:{type:Number,value:0},approxRateResponse:Object,ratesFromSettingsResponse:Object,ratesFromDefaultCurrencyResponse:Object,paymentMethodsResponse:{type:Object},convRates:{type:Object,value:{USD:.85,EUR:1,GBP:1.14,DKK:.13}},isDirectionBuy:{type:Boolean,computed:'_isStringEqualTo(settings.direction, "buy")'},isDirectionSell:{type:Boolean,computed:'!_isStringEqualTo(settings.direction, "buy")'},inCurrencySelected:{type:String,observer:"_updateRates"},outCurrencySelected:{type:String,observer:"_updateRates"},approxRateParams:{type:Object,computed:"_computeRateParamsViaQuote(inCurrencySelected, outCurrencySelected, inAmount)"},ratesFromSettingsParams:{type:Object,computed:"_computeRateParams(settings.minCurrency, inCurrencySelected)"},getRatesFromDefaultCurrencyParams:{type:Object,computed:"_computeDefaultCurrencyRateParams(trader.defaultCurrency, inCurrencySelected, outCurrencySelected, settings.direction)"},createQuoteBody:{type:Object,computed:"_computeCreateQuoteBody(inAmount, inCurrencySelected, outCurrencySelected)"},approxQuote:String,inputStep:{type:Number,computed:"_computeInputStep(currencies)"},minAmountBuyCard:{type:Number,computed:"_getMinInAmountForPaymentMethodAndCurrency(paymentMethodsResponse, 'card', inCurrencySelected)"},minAmountBuyBank:{type:Number,computed:"_getMinInAmountForPaymentMethodAndCurrency(paymentMethodsResponse, 'bank', inCurrencySelected)"},minAmountSell:{type:Number,computed:"_getMinInAmountForPaymentMethodAndCurrency(paymentMethodsResponse, 'blockchain', inCurrencySelected)"},maxInAmountCard:{type:Number,computed:"_computeAmountFromRate(trader.currentLimits.card.in, ratesFromSettingsResponse.rate)"},maxInAmountBank:{type:Number,computed:"_computeAmountFromRate(trader.currentLimits.bank.in, ratesFromSettingsResponse.rate)"},maxOutAmountBank:{type:Number,computed:"_computeAmountFromRate(trader.currentLimits.bank.out, ratesFromSettingsResponse.rate)"},minLimitExceeded:{type:Boolean,value:!1},maxLimitExceeded:{type:Boolean,value:!1},belowMinBankAmountCardIsOkay:{type:Boolean,value:!1},maxCardLimitExceededBankIsOkay:{type:Boolean,value:!1},betweenMaxCardAndMinBank:{type:Boolean,value:!1},minLimit:{type:Number},maxLimit:{type:Number},minLimitCard:{type:Number},maxLimitCard:{type:Number},minLimitBank:{type:Number},maxLimitBank:{type:Number},unfinishedTrades:{type:Boolean,value:!1},debounceInterval:{type:Number,value:300},isCardEnabled:{type:Boolean,value:!0,notify:!0},isBankEnabled:{type:Boolean,value:!0,notify:!0}},_traderChanged:function(){this._updateRates(),this._onSettingsTraderOrPaymentMethodsChanged()},_updateRates:function(){this.minLimitExceeded=!1,this.maxLimitExceeded=!1,this.maxCardLimitExceededBankIsOkay=!1,this.betweenMaxCardAndMinBank=!1,this.belowMinBankAmountCardIsOkay=!1,this.inCurrencySelected&&this.outCurrencySelected&&this.trader?(this.$.approxRateEndpoint.generateRequest(),this.$.getRatesFromSettings.generateRequest(),this.$.getRatesFromDefaultCurrency.generateRequest(),this.tempQuote=null):console.log("Ignored updating rates, missing in/out currency and trader profile.")},_onSettingsTraderOrPaymentMethodsChanged:function(){var e=!1,t=!0;if(this.settings&&this.trader){var n=this.trader.email||"",i=window.location.hostname.indexOf("sandbox")>=0&&(n.indexOf("jbo@coinify.com")>=0||n.indexOf("+enable-all-currencies-sandbox@coinify.com")>=0);t=!i}this.settings&&this.trader&&t&&(this.settings.inCurrencies.indexOf("USD")>=0&&(this.settings.inCurrencies=this.settings.inCurrencies.filter(function(e){return"USD"!==e}),e=!0),this.settings.inCurrencies.indexOf("DKK")>=0&&"DK"!==this.trader.profile.address.country&&(this.settings.inCurrencies=this.settings.inCurrencies.filter(function(e){return"DKK"!==e}),e=!0)),e&&(this.settings=Object.assign({},this.settings))},_handleApproxRateResponse:function(e,t){if(this.errorMessage="",this.inAmountDirty=!1,this.approxRateResponse){this.approxRateResponseTime=(new Date).getTime(),this.tempQuote=Object.assign({},this.approxRateResponse);var n=Math.abs(this.approxRateResponse.baseAmount);n>0&&(this.approxRateResponse.baseAmount/=n,this.approxRateResponse.quoteAmount/=n)}this._updateApproxQuote()},_getInAmountBounds:function(){var e={bank:{min:0,max:0},card:{min:0,max:0},minLimitExceeded:!1,maxLimitExceeded:!1,maxCardLimitExceededBankIsOkay:!1,betweenMaxCardAndMinBank:!1,belowMinBankAmountCardIsOkay:!1,min:0,max:0},t=this.paymentMethodsResponse;if(!(this.inAmount&&"0"!==this.inAmount&&this.inCurrencySelected&&t&&this.trader))return e;var n=t.find(function(e){return"bank"===e.inMedium}),i=t.find(function(e){return"card"===e.inMedium}),r=t.find(function(e){return"blockchain"===e.inMedium}),a=this.inCurrencySelected,o=[],u=[],s=void 0,m=void 0,d=void 0,c=void 0;if("BTC"===a){var p=r.minimumInAmounts[a],l=r.limitInAmounts[a];o.push(p),u=[l]}else{s=i.minimumInAmounts[a],m=i.limitInAmounts[a];var y=!1;if(s>m&&(s=m=0,y=!0),d=n.minimumInAmounts[a],c=n.limitInAmounts[a],1===this.trader.level.id){var h=this.getConvRates()[a]||1;c=this.trader.nextLevel.limits.bank["in"].daily/h}var b=!1;d>c&&(d=c=0,b=!0),d>0&&!b&&o.push(d),s>0&&!y&&o.push(s),o.length||o.push(x),u=[m,c]}var x=Math.min.apply(Math,toConsumableArray(o.filter(Number.isFinite))),A=Math.max.apply(Math,toConsumableArray(u.filter(Number.isFinite)));return e.min=x,e.max=A,e.card.min=s,e.card.max=m,e.bank.min=d,e.bank.max=c,e.minLimitExceeded=this.inAmount<x,e.maxLimitExceeded=this.inAmount>A,e.maxCardLimitExceededBankIsOkay="BTC"!==a&&this.inAmount>m&&this.inAmount<=c,e.betweenMaxCardAndMinBank="BTC"!==a&&this.inAmount>m&&this.inAmount<d&&d>m&&d>0&&s>0,e.belowMinBankAmountCardIsOkay="BTC"!==a&&this.inAmount<d&&this.inAmount<=m,console.log("Limits; card: ",[s,m]," bank: ",[d,c]," bounds ",e),e},_inAmountUpdated:function(){var e=this;this.inAmountDirty=!0,this.tempQuote=null,this.inAmount&&"0"!==this.inAmount&&this.debounce("_updateRates",function(){e.$.approxRateEndpoint.generateRequest()},this.debounceInterval),this._updateApproxQuote()},_updateApproxQuote:function(){var e=this;return this.inAmount&&"0"!==this.inAmount&&this.approxRateResponse?void this.debounce("_updateApproxQuote",function(){if(!e.inAmount||"0"===e.inAmount||!e.approxRateResponse)return void(e.approxQuote="");var t=e._getInAmountBounds();e.minLimit=t.min,e.maxLimit=t.max,e.minLimitCard=t.card.min,e.maxLimitCard=t.card.max,e.minLimitBank=t.bank.min,e.maxLimitBank=t.bank.max,e.minLimitExceeded=t.minLimitExceeded,e.maxLimitExceeded=t.maxLimitExceeded,e.betweenMaxCardAndMinBank=t.betweenMaxCardAndMinBank&&!e.minLimitExceeded&&!e.maxLimitExceeded,e.maxCardLimitExceededBankIsOkay=!e.betweenMaxCardAndMinBank&&!e.minLimitExceeded&&!e.maxLimitExceeded&&"buy"===e.settings.direction&&t.maxCardLimitExceededBankIsOkay,e.belowMinBankAmountCardIsOkay=!e.betweenMaxCardAndMinBank&&!e.minLimitExceeded&&!e.maxLimitExceeded&&!e.maxCardLimitExceededBankIsOkay&&"buy"===e.settings.direction&&t.belowMinBankAmountCardIsOkay,e.isCardEnabled=e.inAmount>=t.card.min&&e.inAmount<=t.card.max,e.isBankEnabled=e.inAmount>=t.bank.min&&e.inAmount<=t.bank.max;var n="BTC"===e.outCurrencySelected?8:2,i=Math.abs(e.approxRateResponse.quoteAmount),r=e.inAmount*i;e.approxQuote=Number(r.toFixed(n))},this.debounceInterval):(this.minLimitExceeded=!1,this.maxLimitExceeded=!1,this.maxCardLimitExceededBankIsOkay=!1,this.belowMinBankAmountCardIsOkay=!1,this.isCardEnabled=!0,void(this.isBankEnabled=!0))},_submitAmount:function(e){e.preventDefault(),this._createQuote()},_calculateContinueButtonEnabled:function(e,t,n,i,r){return e&&e>0&&!t&&!n&&!i&&!r},_computeCreateQuoteBody:function(e,t,n){var i=e*-1;return{baseCurrency:t,quoteCurrency:n,baseAmount:i}},_createQuote:function(){var e=Math.round(((new Date).getTime()-this.approxRateResponseTime)/1e3);return e>=60||!this.tempQuote||this.inAmountDirty?void this.$.tradeQuoteEndpoint.generateRequest():(this.tradeQuote=Object.assign({},this.tempQuote),void this._handleTradeQuoteResponse())},_handleTradeQuoteResponse:function(e){this.errorMessage="",this.fire("completed",null,{bubbles:!1})},getConvRates:function(){return this.convRates},_computeRateParams:function(e,t){return{baseCurrency:e,quoteCurrency:t}},_computeRateParamsViaQuote:function(e,t,n){return{baseCurrency:e,quoteCurrency:t,baseAmount:-(n?n:1)}},_computeDefaultCurrencyRateParams:function(e,t,n,i){var r=n;return"sell"==i&&(r=t),{baseCurrency:e,quoteCurrency:r}},_computeAmountFromRate:function(e,t){return e*t},_minDisplayAmountForBank:function(e,t){if(e<=0&&1===this.trader.level.id)try{var n=this.getConvRates()[t]||1,i=this.trader.nextLevel.limits.bank["in"].daily/n;return this._formatAmountAlt(i,t)}catch(r){return console.error(r),this._formatAmountAlt(e,t)}return this._formatAmountAlt(e,t)},_getMinInAmountForPaymentMethodAndCurrency:function(e,t,n){try{if(e||console.error("Payment methods not present"),!e.find)return void console.log("Object doesnt have a find method");var i=e.find(function(e){return e.inMedium===t});return i&&i.inCurrencies?i.minimumInAmounts[n]:0}catch(r){return console.error(r),0}},resetElement:function(){this.approxQuote="",this.tradeQuote=null,this.tempQuote=null,this.approxRateResponse=null,this._updateRates(),this.$.currencyInput.resetElement()}})</script> </dom-module>
<link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-overlay.html"> <link rel="import" href="../../iron-selector/iron-selector.html"> <link rel="import" href="../../iron-icons/iron-icons.html"> <dom-module id="coinify-bank-account-list"> <template> <style include="coinify-shared">.iron-selected{background-color:#288BAE;color:#fff}</style> <iron-ajax id="getBankAccount" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/bank-accounts" last-response="{{bankAccounts}}" on-error="_handleApiError" handle-as="json"> </iron-ajax> <iron-ajax id="deleteBankAccount" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/bank-accounts/{{bankAccountToDelete.id}}" method="DELETE" on-response="_onDeleteBankAccountResponse" on-error="_onDeleteBankAccountError" handleas="json"> </iron-ajax> <form on-submit="_submitBankAccountChoice"> <coinify-alert-message alert-message="{{alertMessage}}" alert-type="{{alertType}}"> </coinify-alert-message> <label>Choose bank account:</label> <template is="dom-if" if="[[!bankAccounts.length]]"> <div class="alert alert-info"> <strong>Info!</strong> No bank accounts are registered with your profile yet. Please add a bank account to your profile to continue. </div> </template> <template is="dom-if" if="[[bankAccounts.length]]"> <div class="list-group"> <iron-selector selected="{{selectedIndex}}"> <template is="dom-repeat" items="{{bankAccounts}}" as="bankAccount"> <div class="list-group-item"> <div class="row"> <div class="col-xs-10"> <template is="dom-if" if="[[bankAccount.bank.name]]"> <div class="row"> <div class="col-xs-3"><b>Bank name</b></div> <div class="col-xs-5">[[bankAccount.bank.name]]</div> </div> </template> <template is="dom-if" if="[[bankAccount.holder.name]]"> <div class="row"> <div class="col-xs-3"><b>Account holder</b></div> <div class="col-xs-5">[[bankAccount.holder.name]]</div> </div> </template> <template is="dom-if" if="[[bankAccount.account.currency]]"> <div class="row"> <div class="col-xs-3"><b>Account currency</b></div> <div class="col-xs-5">[[bankAccount.account.currency]]</div> </div> </template> <template is="dom-if" if="[[bankAccount.account.number]]"> <div class="row"> <div class="col-xs-3"><b>Account number</b></div> <div class="col-xs-5">[[_generateBankAccountNumberWithAsterisks(bankAccount)]]</div> </div> </template> </div> <div class="col-xs-2"> <button type="button" title="Delete bank account" class="btn btn-link pull-right" on-tap="_openDeleteBankAccountDialog"> <fa-awesome class="text-danger" icon="fa:times-circle" size="17"></fa-awesome> </button> </div> </div> </div> </template> </iron-selector> </div> <template is="dom-if" if="{{_bankAccountAndTradeCurrencyMismatch(selectedBankAccount, tradeQuote)}}"> <div class="alert alert-warning"> <iron-icon icon="icons:warning"></iron-icon> <strong>Warning!</strong> The payout currency you selected ({{tradeQuote.quoteCurrency}}) does not match the currency of the selected bank account ({{selectedBankAccount.account.currency}}). Please choose or add a bank account with currency {{tradeQuote.quoteCurrency}}, or start a new trade with payout in currency matching your preferred bank account. </div> </template> </template> <button type="submit" disabled="{{_bankAccountAndTradeCurrencyMismatch(selectedBankAccount, tradeQuote)}}" class="btn btn-success pull-right">Continue </button> </form> <coinify-overlay id="deleteBankAccountDialog" with-backdrop=""> <h3>Delete bank account {{_generateBankAccountNumberWithAsterisks(bankAccountToDelete)}}?</h3> <p>You are about to delete your bank account {{_generateBankAccountNumberWithAsterisks(bankAccountToDelete)}}</p> <p>Are you sure that you want to do this?</p> <button on-tap="_closeDeleteBankAccountDialog" class="btn btn-default">No, don&apos;t delete</button> <button on-tap="_deleteBankAccount" class="btn btn-danger pull-right">Yes, delete</button> </coinify-overlay> </template> <script>Polymer({is:"coinify-bank-account-list",behaviors:[CoinifyApiBehaviour],properties:{alertMessage:String,alertType:String,errorMessage:{type:String,observer:"_errorMessageChanged"},tradeQuote:Object,bankAccounts:Object,selectedIndex:{type:Number},selectedBankAccount:{type:Object,computed:"_computeSelectedBankAccount(bankAccounts, selectedIndex)",notify:!0},bankAccountToDelete:Object},attached:function(){this.updateList()},_bankAccountAndTradeCurrencyMismatch:function(e,t){return!(!e||!t)&&t.quoteCurrency!==e.account.currency},updateList:function(){this.accessToken&&this.$.getBankAccount.generateRequest()},_generateBankAccountNumberWithAsterisks:function(e){var t=e.account.number;return"*".repeat(t.length-5)+t.slice(-5)},_computeSelectedBankAccount:function(e,t){return e.length?e[t]:null},_submitBankAccountChoice:function(e){e.preventDefault(),this.fire("completed",null,{bubbles:!1})},_openDeleteBankAccountDialog:function(e){this.bankAccountToDelete=e.model.get("bankAccount"),this.$.deleteBankAccountDialog.open()},_closeDeleteBankAccountDialog:function(){delete this.bankAccountToDelete,this.$.deleteBankAccountDialog.close()},_deleteBankAccount:function(){this.$.deleteBankAccount.generateRequest(),this.$.deleteBankAccountDialog.close()},_onDeleteBankAccountResponse:function(e,t){var n=this.bankAccountToDelete;if(delete this.bankAccountToDelete,204!==t.status)return console.error("Expected 204 No Content. Got "+t.status+" "+t.statusText),this.alertType="danger",void(this.alertMessage="Error deleting bank account. Please try again later.");var c=this._generateBankAccountNumberWithAsterisks(n);this.alertType="success",this.alertMessage="Bank account "+c+" deleted.";var o=this.bankAccounts.indexOf(n);console.log("Index ",o),this.splice("bankAccounts",o,1)},_onDeleteBankAccountError:function(e,t){return delete this.bankAccountToDelete,this._handleApiError(e)}})</script> </dom-module>
<link rel="import" href="../../iron-pages/iron-pages.html"> <link rel="import" href="../../iron-input/iron-input.html"> <link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-auth.html"> <link rel="import" href="coinify-create-quote.html"> <link rel="import" href="coinify-create-bank-account.html"> <link rel="import" href="coinify-bank-account-list.html"> <link rel="import" href="coinify-confirm-order.html"> <link rel="import" href="coinify-btc-payment.html"> <dom-module id="coinify-sell"> <template> <style include="coinify-shared"></style> <iron-ajax id="traderInfoEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me" last-response="{{traderInfo}}" on-error="_handleApiError" handleas="json"> </iron-ajax> <coinify-trade-page title="Sell Bitcoin" general-error="{{generalError}}" panel-wrap="{{panelWrap}}" trade-quote="{{tradeQuote}}" trade="{{trade}}"> <iron-pages attr-for-selected="pageId" selected="{{currentPageId}}"> <div pageid="login"> <coinify-auth access-token="{{accessToken}}"> </coinify-auth> </div> <div pageid="createQuote"> <coinify-create-quote id="coinifyCreateQuote" access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" settings="[[settings]]" trader="[[traderInfo]]" trade-quote="{{tradeQuote}}" on-completed="_tradeQuoteCreated"> </coinify-create-quote> </div> <div pageid="choosePayoutBankAccount"> <coinify-create-bank-account id="coinifyCreateBankAccount" access-token="{{accessToken}}" coinify-api-base-url="[[coinifyApiBaseUrl]]" on-created="_handleBankAccountCreated" on-error="_handleApiError"> </coinify-create-bank-account> <coinify-bank-account-list id="coinifyBankAccountList" access-token="{{accessToken}}" coinify-api-base-url="[[coinifyApiBaseUrl]]" trade-quote="[[tradeQuote]]" selected-bank-account="{{selectedBankAccount}}" on-completed="_handleBankAccountSelected" on-error="_handleApiError"> </coinify-bank-account-list> </div> <div pageid="createTrade"> <coinify-confirm-order id="confirmOrder" access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" hide-bitcoin-address-user-input="true" trader-info="[[traderInfo]]" price-quote="{{tradeQuote}}" selected-bank-account="[[selectedBankAccount]]" selected-payment-method="bank" direction="sell" on-cancel="_tradeCancelled" on-continue="_tradeCreated"> </coinify-confirm-order> </div> <div pageid="btcPayment"> <coinify-btc-payment access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" trader-info="[[traderInfo]]" trade="[[trade]]" on-cancel="_btcPaymentCancelled" on-continue="_btcPaymentFinished"> </coinify-btc-payment> </div> <div pageid="paymentOrderStatus"> <coinify-trade-status access-token="[[accessToken]]" coinify-api-base-url="[[coinifyApiBaseUrl]]" trade="[[trade]]"> </coinify-trade-status> <button on-tap="goToCreateQuote" class="btn btn-default pull-right" type="button">New trade</button> </div> </iron-pages> </coinify-trade-page> </template> <script>Polymer({is:"coinify-sell",behaviors:[CoinifyApiBehaviour],listeners:{"price-quote-expired":"_refreshPriceQuote"},properties:{settings:{type:Object,value:{direction:"sell",minAmount:10,minCurrency:"EUR",inCurrencies:["BTC"],outCurrencies:["EUR","USD","GBP","DKK"]}},currentPageId:{type:String,value:"createQuote"},traderInfo:Object,tradeQuote:{type:Object,notify:!0},selectedBankAccount:Object,trade:{type:Object,notify:!0}},attached:function(){return this.accessToken?this.trade?void this.set("currentPageId","btcPayment"):this._initSellProcess():void this.set("currentPageId","login")},ready:function(){this.addEventListener("userAuthorized",this.userAuthorized)},resetTrade:function(){this.$.coinifyCreateQuote.inAmount=null,this.tradeQuote=null,this.$.coinifyBankAccountList.selectedIndex=0,this.$.confirmOrder._resetElement(),this.trade=null},_tradeCancelled:function(){this.resetTrade(),this._initSellProcess()},_tradeCreated:function(e){this.trade=e.detail.trade,this.set("currentPageId","btcPayment")},_btcPaymentFinished:function(){this.set("currentPageId","paymentOrderStatus")},userAuthorized:function(){this._initSellProcess()},_initSellProcess:function(){this.set("currentPageId","createQuote"),this.$.traderInfoEndpoint.generateRequest(),this.$.coinifyBankAccountList.updateList()},_tradeQuoteCreated:function(){this.set("currentPageId","choosePayoutBankAccount")},_handleBankAccountCreated:function(){this.$.coinifyBankAccountList.updateList(),this.$.coinifyBankAccountList.selectedIndex=0},_handleBankAccountSelected:function(){return this.selectedBankAccount?(this.generalError="",void this.set("currentPageId","createTrade")):void(this.generalError="You must choose a bank account to continue")},goToCreateQuote:function(){this.resetTrade(),this.set("currentPageId","createQuote")},_refreshPriceQuote:function(){this.$.coinifyCreateQuote._createQuote()}})</script> </dom-module>
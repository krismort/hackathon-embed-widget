<link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-overlay.html"> <link rel="import" href="coinify-buy-isignthis.html"> <link rel="import" href="../../fa-awesome/fa-awesome.html"> <dom-module id="coinify-kyc-management"> <template> <style include="coinify-shared"></style> <h4>KYC</h4> <p>Current KYC status: {{kycStatus}}</p> <p></p><div hidden$="{{!canStartKyc}}"><button id="startKycButton" on-tap="_startKycProcess" class="btn btn-success">Start KYC process</button></div><p></p> <p></p><div hidden$="{{!canResumeKyc}}"><button id="resumeKycButton" on-tap="_resumeKycProcess" class="btn btn-success">Resume KYC process</button></div><p></p> <coinify-overlay id="istOverlay" with-backdrop="" no-cancel-on-esc-key="" no-cancel-on-outside-click=""> <div class="pull-right"> <button title="Close" class="btn btn-link" on-tap="_closeIstOverlay"> <fa-awesome class="text-danger" icon="fa:times-circle" size="17"></fa-awesome> </button> </div> <coinify-buy-isignthis ist-base-url="{{istBaseUrl}}" external-id="{{iSignThisExternalId}}" on-completed="_handleISTProcessCompleted"> </coinify-buy-isignthis> </coinify-overlay> <coinify-overlay id="jumioOverlay" with-backdrop="" no-cancel-on-esc-key="" no-cancel-on-outside-click=""> <div class="pull-right"> <button title="Close" class="btn btn-link" on-tap="_closeJumioOverlay"> <fa-awesome class="text-danger" icon="fa:times-circle" size="17"></fa-awesome> </button> </div> <iframe src="{{jumioUrl}}" width="700" height="550"> </iframe> </coinify-overlay> <iron-ajax id="traderEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me" method="GET" last-response="{{trader}}" on-error="_handleGetTraderError" handle-as="json"> </iron-ajax> <iron-ajax id="kycReviewsEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/kyc" method="GET" last-response="{{kycReviews}}" on-response="_handleKycReviewsUpdated" on-error="_handleGetKycReviewsError" handle-as="json"> </iron-ajax> <iron-ajax id="prepareKycEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me/kyc" method="POST" last-response="{{preparedKyc}}" on-error="_handleApiError" handle-as="json"> </iron-ajax> <iron-ajax id="kycProviderEndpoint" auto="" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/traders/me/kyc-provider" method="GET" last-response="{{kycProvider}}" on-error="_handleApiError" handle-as="json"> </iron-ajax> </template> <script>Polymer({is:"coinify-kyc-management",behaviors:[CoinifyApiBehaviour],properties:{istBaseUrl:{type:String,value:"https://verify.isignthis.com"},trader:{type:Object},kycReviews:Object,kycStatus:{type:String,computed:"_computeKycStatus(kycReviews.*)"},iSignThisExternalId:{type:String},preparedKyc:{type:Object},kycProvider:{type:Object},canStartKyc:{type:Boolean,computed:"_computeCanStartKyc(trader.nextLevel.requirements, kycReviews.*)",value:!1},canResumeKyc:{type:Boolean,computed:"_computeCanResumeKyc(kycReviews.*)",value:!1},jumioUrl:{type:String}},attached:function(){this.$.kycReviewsEndpoint.generateRequest(),this.$.traderEndpoint.generateRequest()},_handleKycReviewsUpdated:function(){this.$.startKycButton.disabled=!1,this.$.resumeKycButton.disabled=!1},_handleGetKycReviewsError:function(e){console.log("_handleGetKycReviewsError",e)},_handleGetTraderError:function(e){console.log("_handleGetTraderError",e)},_modalClosed:function(){this.fire("coinify-kyc-management-closed")},_computeKycStatus:function(e){var t=e.base;if(!t||t.length<1)return"Not started";var n=this._getCompletedKycReviews(t).length>0,i=this._getKycReviewsInReview(t).length>0,r=this._getResumableKycReviews(t).length>0;return n?"Complete":i?"Under review":r?"In progress":"Not started"},_startKycProcess:function(){var e=this;this.$.prepareKycEndpoint.generateRequest().completes.then(function(){console.log("data ",e.preparedKyc),e.jumioUrl=e.preparedKyc.redirectUrl,e.$.jumioOverlay.open()},function(e){console.log(e)})},_resumeKycProcess:function(){this.$.startKycButton.disabled=!0,this.$.resumeKycButton.disabled=!0,this.iSignThisExternalId=this._getResumableKycReviews(this.kycReviews)[0].externalId,this.$.istOverlay.open()},_kycReviewCompleted:function(e){var t=e.base;if(!t||e.length<1)return!1;var n=function(e){return"completed"===e.state};return t.filter(n)},_closeJumioOverlay:function(){this.$.jumioOverlay.close()},_closeIstOverlay:function(){this.$.istOverlay.close(),this.$.kycReviewsEndpoint.generateRequest()},_handleISTProcessCompleted:function(){var e=this,t=this.kycReviews.findIndex(function(e){return"pending"===e.state});t>-1&&this.set("kycReviews.#"+t+".state","reviewing"),this.$.istOverlay.close(),this.async(function(){e.$.kycReviewsEndpoint.generateRequest()},2e4)},_computeCanStartKyc:function(e,t){var n=t.base;if(!n||!e)return!1;var i=e.filter(function(e){return"kyc"===e.type}).length>0,r=this._getResumableKycReviews(n).length>0,s=this._getKycReviewsInReview(n).length>0,c=this._getCompletedKycReviews(n).length>0;return i&&!r&&!s&&!c},_computeCanResumeKyc:function(e){var t=e.base;if(!t||t.length<1)return!1;var n=this._getCompletedKycReviews(t).length>0,i=this._getKycReviewsInReview(t).length>0,r=this._getResumableKycReviews(t).length>0;return r&&!n&&!i},_getResumableKycReviews:function(e){return e.filter(function(e){return"pending"===e.state||"documentsRequested"===e.state})},_getKycReviewsInReview:function(e){return e.filter(function(e){return"reviewing"===e.state})},_getCompletedKycReviews:function(e){return e.filter(function(e){return"completed"===e.state})}})</script> </dom-module>
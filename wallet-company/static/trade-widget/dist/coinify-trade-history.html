<link rel="import" href="coinify-shared.html"> <link rel="import" href="coinify-api-behaviour.html"> <link rel="import" href="coinify-alert-message.html"> <link rel="import" href="coinify-trade-page.html"> <link rel="import" href="coinify-buy.html"> <link rel="import" href="coinify-trade-status.html"> <link rel="import" href="coinify-overlay.html"> <link rel="import" href="../../iron-ajax/iron-ajax.html"> <link rel="import" href="../../time-display/time-display.html"> <link rel="import" href="../../mercury-paginator/mercury-paginator.html"> <link rel="import" href="../../fa-awesome/fa-awesome.html"> <dom-module id="coinify-trade-history"> <template> <style include="coinify-shared"></style> <style>.table-text{padding-top:15px!important}.table-cancel{padding:9px 2px 0 2px!important}#cancelTradeDialog{max-width:400px}#modalBody{max-width:750px}</style> <coinify-trade-page title="Trade History" general-error="{{generalError}}" panel-wrap="{{panelWrap}}"> <table id="tradehistorytable" class="table table-striped"> <thead> <tr> <th>Status</th> <th>Trade ID</th> <th></th> <th>Date</th> <th>You buy</th> <th>You pay (via)</th> <th></th> </tr> </thead> <tbody> <template is="dom-repeat" items="{{tradesApiResponse}}"> <tr> <td class="table-text">{{localize(&apos;trade_history_trade_status&apos;, &apos;status&apos;, item.state)}}</td> <td class="table-text">#{{item.id}}</td> <td><button class="btn btn-link" on-tap="_doTradeAction">{{_tradeActionText(item)}}</button></td> <td class="table-text"><time-display datetime="{{item.createTime}}" format="D MMMM YYYY HH:mm:ss"></time-display></td> <td class="table-text">{{item.transferOut.receiveAmount}} {{item.transferOut.currency}}</td> <td class="table-text">{{item.transferIn.sendAmount}} {{item.transferIn.currency}}{{_mediumPostfix(item.transferIn.medium)}}</td> <td class="table-cancel"> <div hidden$="{{!_tradeCancelable(item)}}"> <button title="Cancel trade" class="btn btn-link" on-tap="_openCancelTradeDialog"><fa-awesome class="text-danger" icon="fa:times-circle" size="17"></fa-awesome></button> </div> </td> </tr> </template> </tbody> </table> <mercury-paginator id="paginator" perpage="{{tradesPerPage}}" items="{{tradesApiResponse}}" style="display:none"> </mercury-paginator> </coinify-trade-page> <iron-ajax id="tradesEndpoint" headers="{{ajaxHeaders}}" url="{{coinifyApiBaseUrl}}/trades" last-response="{{tradesApiResponse}}" on-response="_onTradesResponse" on-error="_onTradesError" handleas="json"> </iron-ajax> <iron-ajax id="cancelTradeEndpoint" headers="{{ajaxHeaders}}" method="PATCH" url="{{coinifyApiBaseUrl}}/trades/{{tradeToCancel.id}}/cancel" on-response="_onCancelTradeResponse" on-error="_onCancelTradeError" handleas="json"> </iron-ajax> <coinify-overlay id="cancelTradeDialog" with-backdrop=""> <p>Are you sure you want to cancel the trade?</p> <template is="dom-if" if="{{_isTradeBankIn(tradeToCancel)}}"> <div class="alert alert-warning"> <strong>Notice:</strong> Cancelling will not stop this Trade if you have already sent your bank transfer. If we receive a bank transfer from you, we will still process your Trade. </div> </template> <button on-tap="_closeCancelTradeDialog" class="btn btn-default">No</button> <button on-tap="_cancelTrade" class="btn btn-success pull-right">Yes</button> </coinify-overlay> <coinify-overlay id="tradeActionOverlay" with-backdrop="" no-cancel-on-esc-key="" no-cancel-on-outside-click=""> <div class="pull-right"> <button title="Close" class="btn btn-link" on-tap="_closeOverlay"> <fa-awesome class="text-danger" icon="fa:times-circle" size="17"></fa-awesome> </button> </div> <h3>{{modalTitle}}</h3> <div id="modalBody"></div> <button type="button" class="btn btn-default" on-tap="_closeOverlay" data-dismiss="modal">Close</button> </coinify-overlay> </template> <script>Polymer({is:"coinify-trade-history",behaviors:[Polymer.AppLocalizeBehavior,CoinifyApiBehaviour],properties:{language:{value:"en"},generalError:{type:String,notify:!0},panelWrap:{type:Object,value:!0},tradesApiResponse:{type:Object},tradesPerPage:{type:Number,value:15},istBaseUrl:{type:String,value:"https://verify.isignthis.com"},modalTitle:String,currentTradeObject:Object,paymentMethod:String,tradeToCancel:Object},attached:function(){this._updateTrades()},ready:function(){this.loadResources("assets/config/locales.json")},_accessTokenChanged:function(e){e&&this._updateTrades()},_updateTrades:function(){this.$.tradesEndpoint.generateRequest()},_onTradesResponse:function(){this.generalError="",this.tradesApiResponse&&this.tradesApiResponse.length>this.tradesPerPage?(this.$.paginator.data=this.tradesApiResponse,$(this.$.paginator).show()):$(this.$.paginator).hide()},_onTradesError:function(e){console.log("Error fetching trades from API: ",e),this.generalError="We encountered an error while getting trades - please try again later."},_tradeActionText:function(e){return this._tradeResumable(e)?"Finish payment":"View details"},_doTradeAction:function(e){var t=this;Polymer.dom(this.$.modalBody).children.forEach(function(e){Polymer.dom(t.$.modalBody).removeChild(e)});var a=e.model.get("item"),n=void 0;this._tradeResumable(a)?"BTC"===a.inCurrency?(this.modalTitle="Sell bitcoins",n=this._loadSellComponent(a)):(this.modalTitle="Buy bitcoins",n=this._loadBuyComponent(a)):(this.modalTitle="Trade details",n=this._loadTradeDetails(a)),this.$.modalBody.appendChild(n),this.$.tradeActionOverlay.open()},_loadSellComponent:function(e){var t=document.createElement("coinify-sell");return t.panelWrap=!1,t.accessToken=this.accessToken,t.coinifyApiBaseUrl=this.coinifyApiBaseUrl,t.trade=e,t.newTradeButtonEnabled=!1,t},_loadBuyComponent:function(e){var t=document.createElement("coinify-buy");t.panelWrap=!1,t.accessToken=this.accessToken,t.coinifyApiBaseUrl=this.coinifyApiBaseUrl,t.istBaseUrl=this.istBaseUrl,t.trade=e,t.newTradeButtonEnabled=!1;var a=this;return t.onCancelCallback=function(){a._closeOverlay()},t},_loadTradeDetails:function(e){var t=document.createElement("coinify-trade-status");return t.accessToken=this.accessToken,t.coinifyApiBaseUrl=this.coinifyApiBaseUrl,t.trade=e,t},_closeOverlay:function(){this._updateTrades(),this.$.tradeActionOverlay.close()},_tradeResumable:function(e){var t=Date.parse(e.quoteExpireTime)<(new Date).getTime(),a="BTC"===e.inCurrency;return(!a||!t)&&"awaiting_transfer_in"===e.state},_tradeCancelable:function(e){return"awaiting_transfer_in"===e.state},_openCancelTradeDialog:function(e){var t=e.model.get("item");this.tradeToCancel=t,this.$.cancelTradeDialog.open()},_isTradeBankIn:function(e){return!!e&&"bank"===e.transferIn.medium},_closeCancelTradeDialog:function(){this.$.cancelTradeDialog.close(),this.tradeToCancel=null},_cancelTrade:function(){this.$.cancelTradeEndpoint.generateRequest(),this._closeCancelTradeDialog()},_onCancelTradeResponse:function(){this._updateTrades()},_onCancelTradeError:function(e){console.log("Error canceling trade from API: ",e),this.generalError="We encountered an error while canceling trade - please try again later."},_mediumPostfix:function(e){switch(e){case"card":return" (Card)";case"bank":return" (Bank)";default:return""}}})</script> </dom-module>